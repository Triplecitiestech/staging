// Prisma Schema for Triple Cities Tech Project Status Platform
// Supports AI-generated project plans with customer-facing status pages

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// STAFF USERS & AUTHENTICATION
// ============================================

model StaffUser {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String
  role      StaffRole @default(VIEWER)
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  blogPosts BlogPost[]

  @@map("staff_users")
}

enum StaffRole {
  ADMIN // Full control - can manage staff, delete projects
  MANAGER // Can create/edit projects and templates
  VIEWER // Read-only access to admin dashboard
}

// ============================================
// NEXTAUTH TABLES (Required for authentication)
// ============================================

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// COMPANIES & PROJECTS
// ============================================

model Company {
  id             String   @id @default(uuid())
  slug           String   @unique // URL-friendly: 'acme-manufacturing'
  displayName    String // 'Acme Manufacturing'
  primaryContact String?
  contactTitle   String?
  contactEmail   String?
  passwordHash   String // bcrypt hash for customer portal access
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  projects Project[]

  @@map("companies")
}

model Project {
  id                String        @id @default(uuid())
  companyId         String
  projectType       ProjectType
  title             String // 'Microsoft 365 Migration & Security'
  slug              String        @unique // 'acme-manufacturing-m365-migration'
  currentPhaseId    String? // Track which phase they're on
  status            ProjectStatus @default(ACTIVE)
  estimatedDuration String? // '30 days', '6 weeks'
  startedAt         DateTime?
  completedAt       DateTime?
  createdBy         String // Staff email
  lastModifiedBy    String // Staff email
  aiGenerated       Boolean @default(false)
  generationPrompt  String? @db.Text // Original prompt sent to Claude API
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  phases    Phase[]
  auditLogs AuditLog[]

  @@map("projects")
}

enum ProjectType {
  ONBOARDING // New client onboarding
  M365_MIGRATION // Microsoft 365 migration
  FORTRESS // TCT Fortress security implementation
  CUSTOM // Custom project
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

// ============================================
// PHASES & TASKS
// ============================================

model Phase {
  id            String      @id @default(uuid())
  projectId     String
  title         String
  description   String?     @db.Text
  status        PhaseStatus @default(NOT_STARTED)
  owner         PhaseOwner?
  estimatedDays Int?
  scheduledDate DateTime?
  completedDate DateTime?
  orderIndex    Int // For sorting (1, 2, 3...)
  customerNotes String?     @db.Text // Visible to customer
  internalNotes String?     @db.Text // STAFF ONLY - hidden from customer
  nextAction    String?     @db.Text

  // New fields for enhanced phase management
  isVisibleToCustomer Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       PhaseTask[]
  auditLogs   AuditLog[]
  comments    Comment[]
  assignments Assignment[]

  @@map("phases")
}

enum PhaseStatus {
  NOT_STARTED
  SCHEDULED
  WAITING_ON_CUSTOMER
  IN_PROGRESS
  REQUIRES_CUSTOMER_COORDINATION
  DISCUSSED
  COMPLETE
}

enum PhaseOwner {
  TCT
  CUSTOMER
  BOTH
}

enum TaskStatus {
  NOT_STARTED
  ASSIGNED
  WORK_IN_PROGRESS
  WAITING_ON_VENDOR
  WAITING_ON_CLIENT
  NEEDS_REVIEW
  STUCK
  INFORMATION_RECEIVED
  REVIEWED_AND_DONE
  ITG_DOCUMENTED
  NOT_APPLICABLE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model PhaseTask {
  id          String    @id @default(uuid())
  phaseId     String
  taskText    String    @db.Text
  completed   Boolean   @default(false)
  completedBy String? // Staff email
  completedAt DateTime?
  notes       String?   @db.Text
  orderIndex  Int // For sorting

  // New fields for enhanced task management
  status              TaskStatus   @default(NOT_STARTED)
  isVisibleToCustomer Boolean      @default(true)
  assignedTo          String? // Primary assignee email
  assignedToName      String? // Primary assignee display name
  dueDate             DateTime?
  priority            Priority     @default(MEDIUM)
  responsibleParty    PhaseOwner? // TCT, CUSTOMER, or BOTH

  // Sub-tasks support (up to 3 levels deep)
  parentTaskId String? // null for top-level tasks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  phase       Phase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  parent      PhaseTask?   @relation("SubTasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subTasks    PhaseTask[]  @relation("SubTasks")
  comments    Comment[]
  assignments Assignment[]

  @@map("phase_tasks")
}

// ============================================
// COMMENTS SYSTEM
// ============================================

model Comment {
  id          String   @id @default(uuid())
  phaseId     String?
  taskId      String?
  content     String   @db.Text
  isInternal  Boolean  @default(false) // true = staff only, false = customer can see
  authorEmail String // Staff email or "customer"
  authorName  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  phase Phase?     @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  task  PhaseTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("comments")
}

// ============================================
// ASSIGNMENTS & NOTIFICATIONS
// ============================================

enum NotificationType {
  ASSIGNMENT
  COMMENT
  STATUS_CHANGE
  MENTION
}

model Assignment {
  id            String   @id @default(uuid())
  phaseId       String?
  taskId        String?
  assigneeEmail String // M365 user email
  assigneeName  String
  assignedBy    String // Staff email who made assignment
  assignedAt    DateTime @default(now())

  // Relations
  phase Phase?     @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  task  PhaseTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([phaseId, assigneeEmail])
  @@unique([taskId, assigneeEmail])
  @@map("assignments")
}

model Notification {
  id             String           @id @default(uuid())
  recipientEmail String
  type           NotificationType
  entityType     String // 'phase', 'task', 'comment'
  entityId       String
  title          String
  message        String           @db.Text
  isRead         Boolean          @default(false)
  linkUrl        String?
  createdAt      DateTime         @default(now())

  @@map("notifications")
}

// ============================================
// AUDIT LOGGING
// ============================================

model AuditLog {
  id         String      @id @default(uuid())
  projectId  String
  phaseId    String?
  staffEmail String
  staffName  String?
  staffRole  StaffRole?
  actionType AuditAction
  entityType String // 'project', 'phase', 'task'
  changes    Json? // { before: {...}, after: {...} }
  notes      String?     @db.Text
  createdAt  DateTime    @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase   Phase?  @relation(fields: [phaseId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

enum AuditAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  DELETED
  AI_GENERATED
  TEMPLATE_APPLIED
  PASSWORD_CHANGED
}

// ============================================
// PROJECT TEMPLATES
// ============================================

model ProjectTemplate {
  id          String      @id @default(uuid())
  name        String // 'M365 Migration', 'TCT Fortress Onboarding'
  description String?     @db.Text
  projectType ProjectType
  phasesJson  Json // Pre-defined phase structure
  createdBy   String // Staff email - no foreign key to avoid production DB issues
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("project_templates")
}

// ============================================
// BLOG SYSTEM
// ============================================

model BlogPost {
  id              String        @id @default(uuid())
  slug            String        @unique
  title           String
  excerpt         String        @db.Text
  content         String        @db.Text
  featuredImage   String?

  // AI Generation metadata
  sourceUrls      String[]      // URLs used for inspiration
  aiPrompt        String?       @db.Text
  aiModel         String?       // "claude-sonnet-4-5-20250929"

  // Publishing status
  status          BlogStatus    @default(DRAFT)
  scheduledFor    DateTime?
  publishedAt     DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?       @db.Text
  keywords        String[]

  // Social media
  facebookPostId  String?
  instagramPostId String?
  linkedinPostId  String?
  twitterPostId   String?

  // Approval workflow
  sentForApproval DateTime?
  approvedAt      DateTime?
  approvedBy      String?       // Email of approver
  approvalToken   String?       @unique
  rejectionReason String?       @db.Text
  revisionCount   Int           @default(0)

  // Analytics
  views           Int           @default(0)
  shares          Int           @default(0)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  author          StaffUser?    @relation(fields: [authorId], references: [id])
  authorId        String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id])
  categoryId      String?
  tags            BlogTag[]

  @@map("blog_posts")
  @@index([status, publishedAt])
  @@index([slug])
  @@index([approvalToken])
}

enum BlogStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
  ARCHIVED
}

model BlogCategory {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  posts       BlogPost[]

  @@map("blog_categories")
}

model BlogTag {
  id    String     @id @default(uuid())
  name  String     @unique
  slug  String     @unique
  posts BlogPost[]

  @@map("blog_tags")
}

model ContentSource {
  id              String   @id @default(uuid())
  name            String
  url             String
  rssFeedUrl      String?
  apiEndpoint     String?
  isActive        Boolean  @default(true)
  lastFetched     DateTime?
  fetchFrequency  String   @default("daily") // "hourly", "daily", "weekly"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("content_sources")
}

model SocialMediaPost {
  id          String   @id @default(uuid())
  blogPostId  String
  platform    String   // "facebook", "instagram", "linkedin", "twitter"
  platformId  String?  // Platform-specific post ID
  content     String   @db.Text
  imageUrl    String?
  status      String   @default("pending") // "pending", "posted", "failed"
  postedAt    DateTime?
  error       String?  @db.Text

  createdAt   DateTime @default(now())

  @@map("social_media_posts")
  @@index([blogPostId, platform])
}

model BlogSettings {
  id         String   @id @default(uuid())
  key        String   @unique
  value      String   @db.Text
  updatedAt  DateTime @updatedAt
  updatedBy  String?

  @@map("blog_settings")
}
